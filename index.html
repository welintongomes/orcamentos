<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Or√ßamentos Universal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 13px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 600;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 6px 45px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.3s ease;
    /* margin-right: 10px; */
    margin-bottom: 6px;
}

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }

        .item-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 20px;
        }

.item {
    gap: 10px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
}

        .item-info {
            width: 96.9%;
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
        }

        .item-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        .total-section {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .total-section h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .total-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 20px;
            color: #ddd;
        }

        .dropdown-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .dropdown-suggestions.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item-name {
            font-weight: 600;
            color: #333;
        }

        .dropdown-item-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 2px;
        }

        .autocomplete-container {
            position: relative;
        }

        /* Estilos dos Modais */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #fff;
            margin: 1% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            position: relative;
        }

        .modal-large {
            max-width: 800px;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-actions {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }

        /* Detalhes do or√ßamento */
        .orcamento-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #007bff;
        }

        .orcamento-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
        }

        .orcamento-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .info-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            color: #333;
        }

        .itens-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .itens-table th,
        .itens-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .itens-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .itens-table tr:hover {
            background-color: #f8f9fa;
        }

        .totais-container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .total-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .total-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #007bff;
        }

        .total-label {
            font-weight: bold;
        }

        .total-value {
            font-weight: bold;
        }

        /* CSS para edi√ß√£o de itens */
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .form-section h4 {
            margin-bottom: 15px;
            color: #555;
            font-size: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 120px;
            gap: 15px;
            align-items: end;
        }

        .add-item-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .items-list-section {
            margin-bottom: 20px;
        }

        .item-edicao {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .item-edicao:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .item-edicao-info {
            flex: 1;
        }

        .item-edicao-nome {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .item-edicao-detalhes {
            color: #666;
            font-size: 14px;
        }

        .item-edicao-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
        }

        .totais-edicao {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .totais-edicao .total-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .totais-edicao .total-item:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 18px;
            color: #007bff;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #007bff;
        }

        .empty-items {
            text-align: center;
            padding: 40px;
            color: #666;
            background-color: white;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }

        .empty-items-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* css para x dentro do campo de pesquisa */
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding-right: 30px;
            /* espa√ßo para o X */
        }

        .clear-icon {
            position: absolute;
            right: 10px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
            display: none;
            user-select: none;
        }

        .search-input:not(:placeholder-shown)+.clear-icon {
            display: block;
        }

        .search-input:focus+.clear-icon {
            display: block;
        }

        /* css para importar e exportar */
        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .import-section {
            margin-bottom: 20px;
        }

        .import-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .import-section input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .import-options {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .import-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* css bot√£o ocultar divs */
        .oculto {
            display: none;
        }

        .visivel {
            display: block;
        }

        #material-unidade {
            height: auto;
        }

        /* Limita visualmente a altura da lista */
        input::-webkit-calendar-picker-indicator {
            display: none;
        }

        datalist option {
            max-height: 30px;
        }

        /* .unid{
            height: 12px;
        } */
        .unid1 {
            width: 100%;
            margin-bottom: 11px;
            height: 39px;
            padding: 8px;
        }

        /* css cores de quantidade e validade */
        /* Quantidade */
        /* QUANTIDADE - com degrad√™ */
        .qtd-vermelho {
            background: linear-gradient(to right, #ff4e50, #f44336);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .qtd-laranja {
            background: linear-gradient(to right, #f39c12, #e67e22);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .qtd-verde {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .qtd-azul {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .qtd-roxo {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        /* VALIDADE - com degrad√™ */
        .val-vermelho {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .val-laranja {
            background: linear-gradient(to right, #e67e22, #d35400);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .val-verde {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .val-azul {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .val-roxo {
            background: linear-gradient(to right, #9b59b6, #8e44ad);
            color: white;
            padding: 4px;
            border-radius: 4px;
        }

        .val-sem-info {
            background: linear-gradient(to right, #bdc3c7, #95a5a6);
            color: #2c3e50;
            font-style: italic;
            padding: 4px;
            border-radius: 4px;
        }

        .item-estoque {
            margin: 7px 0px 3px 0px;

        }

        /* css para or√ßamento finalizado */
        .finalizado {
            border-left: 6px solid #2ecc71;
            background-color: #ecf0f1;
        }

        /* Oculto por padr√£o */
        .notificacao-oculta {
            display: none;
        }

        /* Container da notifica√ß√£o cobrindo a tela */
        #notificacao {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: none;
            align-items: flex-start;
            justify-content: center;
        }

        /* Tarja da notifica√ß√£o */
        .notificacao-barra {
            background-color: #2ecc71;
            color: white;
            padding: 16px 24px;
            margin-top: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            font-weight: bold;
            animation: aparecer 0.3s ease;
        }

        /* Anima√ß√£o de entrada */
        @keyframes aparecer {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }




        @media (max-width: 576px) {
            .modal-content {
                padding: 20px;
                width: 95%;
            }

            .orcamento-info {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .itens-table {
                font-size: 14px;
            }

            .itens-table th,
            .itens-table td {
                padding: 8px;
            }

            .tabs {
                flex-direction: column;
            }

            .item {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-actions {
                margin-top: 10px;
                width: 100%;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .item-edicao {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .item-edicao-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .form-section {
                padding: 15px;
            }

            .item-actions {
                display: flex;
                gap: 10px;
                flex-direction: column;
            }

            .botaocentro {
                display: block;
                margin: 0 auto;
            }

            .juntos {
                display: flex;
                justify-content: space-around;
            }

        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Or√ßamentos</h1>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('novo-orcamento')">Novo Or√ßamento</button>
                <button class="tab" onclick="showTab('meus-orcamentos')">Meus Or√ßamentos</button>
                <button class="tab" onclick="showTab('materiais')">Materiais</button>
            </div>

            <div id="novo-orcamento" class="tab-content active">
                <div class="grid">
                    <div class="card">
                        <h3>üìã Informa√ß√µes do Or√ßamento</h3>
                        <div class="form-group">
                            <label for="orcamento-nome">Nome do Or√ßamento</label>
                            <input type="text" id="orcamento-nome" placeholder="Ex: Bolo de Anivers√°rio 2kg">
                        </div>
                        <div class="form-group">
                            <label for="orcamento-descricao">Descri√ß√£o</label>
                            <textarea id="orcamento-descricao" rows="3"
                                placeholder="Descreva os detalhes do or√ßamento..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="margem-lucro">Margem de Lucro (%)</label>
                            <input type="number" id="margem-lucro" placeholder="20" min="0" max="100">
                        </div>
                    </div>

                    <div class="card">
                        <h3>üõí Adicionar Item</h3>
                        <div class="form-group ">
                            <label for="item-nome">Nome do Item</label>
                            <div class="autocomplete-container" style="position: relative;">
                                <div class="search-container">
                                    <input type="text" id="item-nome" placeholder="Ex: Farinha de Trigo"
                                        autocomplete="off" class="search-input">
                                    <span class="clear-icon" onclick="limparCampoBusca(this)">√ó</span>
                                </div>
                                <div id="dropdown-materiais" class="dropdown-suggestions"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="item-preco">Pre√ßo Unit√°rio (R$)</label>
                            <input type="number" id="item-preco" placeholder="3.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="item-quantidade">Quantidade</label>
                            <input type="number" id="item-quantidade" placeholder="0.5" step="0.01">
                        </div>
                        <div>
                            <label for="item-unidade">Unidade</label>
                            <input list="lista-item-unidade" id="item-unidade" name="item-unidade"
                                class="form-control unid1" placeholder="Digite ou selecione">
                            <datalist id="lista-item-unidade">
                                <!-- Massa -->
                                <option value="Quilograma (kg)">
                                <option value="Grama (g)">
                                <option value="Tonelada (t)">
                                <option value="Miligrama (mg)">

                                    <!-- Volume -->
                                <option value="Litro (l)">
                                <option value="Mililitro (ml)">
                                <option value="Metro C√∫bico (m¬≥)">
                                <option value="Cent√≠metro C√∫bico (cm¬≥)">

                                    <!-- Comprimento -->
                                <option value="Metro (m)">
                                <option value="Cent√≠metro (cm)">
                                <option value="Mil√≠metro (mm)">
                                <option value="Polegada (in)">
                                <option value="P√© (ft)">

                                    <!-- √Årea -->
                                <option value="Metro Quadrado (m¬≤)">
                                <option value="Cent√≠metro Quadrado (cm¬≤)">

                                    <!-- Tempo -->
                                <option value="Hora (h)">
                                <option value="Minuto (min)">
                                <option value="Segundo (s)">

                                    <!-- Unidade -->
                                <option value="Unidade (un)">
                                <option value="Pacote (pc)">
                                <option value="Caixa (cx)">
                                <option value="D√∫zia (dz)">
                                <option value="Par (par)">
                            </datalist>
                            <button class="btn botaocentro" onclick="adicionarItem()">Adicionar Item</button>
                        </div>

                    </div>
                </div>

                <div class="item-list">
                    <h3>üì¶ Itens do Or√ßamento</h3>
                    <div id="lista-itens">
                        <div class="empty-state">
                            <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                            <p>Nenhum item adicionado ainda</p>
                        </div>
                    </div>
                </div>

                <div class="total-section">
                    <h3>üí∞ Valor Total</h3>
                    <div class="total-value">R$ <span id="total-valor">0,00</span></div>
                    <button class="btn" onclick="salvarOrcamento()" style="margin-top: 20px;">Salvar Or√ßamento</button>
                </div>
            </div>

            <div id="meus-orcamentos" class="tab-content">
                <div class="card">
                    <h3>üìä Meus Or√ßamentos Salvos</h3>
                    <div class="form-group">
                        <label for="busca-orcamentos">üîç Buscar Or√ßamentos</label>
                        <div class="search-container">
                            <input type="text" id="busca-orcamentos" placeholder="Digite..."
                                oninput="buscarOrcamentos()" class="search-input">
                            <span class="clear-icon" onclick="limparCampoBusca(this)">√ó</span>
                        </div>
                        <!-- Adicionar ap√≥s o campo de busca de or√ßamentos -->
                    </div>
                    <div id="lista-orcamentos">
                        <div class="empty-state">
                            <div style="font-size: 3em; margin-bottom: 20px;">üìä</div>
                            <p>Nenhum or√ßamento salvo ainda</p>
                        </div>
                    </div>
                    <div class="import-export-buttons">
                        <button class="btn" onclick="exportarOrcamentos()">Exportar Or√ßamentos</button>
                        <button class="btn" onclick="abrirModal('modal-importar-orcamentos')">Importar
                            Or√ßamentos</button>
                    </div>
                </div>
            </div>

            <div id="materiais" class="tab-content">
                <div class="card">
                    <h3>üì¶ Cadastrar Material</h3>
                    <div class="form-group">
                        <label for="material-nome">Nome do Material</label>
                        <div class="search-container">
                            <input type="text" id="material-nome" placeholder="Ex: Farinha de Trigo"
                                class="search-input">
                            <span class="clear-icon" onclick="limparCampoBusca(this)">√ó</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="material-preco">Pre√ßo Unit√°rio (R$)</label>
                        <input type="number" id="material-preco" placeholder="3.50" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="material-validade">Data de Validade</label>
                        <input type="date" id="material-validade">
                    </div>
                    <div class="form-group">
                        <label for="material-quantidade">Quantidade</label>
                        <input type="number" id="material-quantidade" min="0" step="0.01" value="10">
                    </div>

                    <input list="lista-material-unidade" id="material-unidade" name="material-unidade"
                        class="form-control unid1" placeholder="Digite ou selecione">
                    <datalist id="lista-material-unidade">
                        <!-- Massa -->
                        <option value="Quilograma (kg)">
                        <option value="Grama (g)">
                        <option value="Tonelada (t)">
                        <option value="Miligrama (mg)">

                            <!-- Volume -->
                        <option value="Litro (l)">
                        <option value="Mililitro (ml)">
                        <option value="Metro C√∫bico (m¬≥)">
                        <option value="Cent√≠metro C√∫bico (cm¬≥)">

                            <!-- Comprimento -->
                        <option value="Metro (m)">
                        <option value="Cent√≠metro (cm)">
                        <option value="Mil√≠metro (mm)">
                        <option value="Polegada (in)">
                        <option value="P√© (ft)">

                            <!-- √Årea -->
                        <option value="Metro Quadrado (m¬≤)">
                        <option value="Cent√≠metro Quadrado (cm¬≤)">

                            <!-- Tempo -->
                        <option value="Hora (h)">
                        <option value="Minuto (min)">
                        <option value="Segundo (s)">

                            <!-- Unidade -->
                        <option value="Unidade (un)">
                        <option value="Pacote (pc)">
                        <option value="Caixa (cx)">
                        <option value="D√∫zia (dz)">
                        <option value="Par (par)">
                    </datalist>


                    <button class="btn botaocentro" onclick="salvarMaterial()">Salvar Material</button>

                </div>

                <div class="item-list">
                    <h3>üì¶ Materiais Cadastrados</h3>
                    <div class="form-group">
                        <label for="busca-materiais"></label>
                        <div class="search-container">
                            <input type="text" id="busca-materiais" placeholder="üîç Digite o nome do material..."
                                oninput="buscarMateriais()" class="search-input">
                            <span class="clear-icon" onclick="limparCampoBusca(this)">√ó</span>
                        </div>
                    </div>

                    <div id="lista-materiais">
                        <div class="empty-state">
                            <div style="font-size: 3em; margin-bottom: 20px;">üì¶</div>
                            <p>Nenhum material cadastrado ainda</p>
                        </div>
                    </div>
                    <!-- Adicionar ap√≥s o campo de busca de materiais -->
                    <div class="import-export-buttons">
                        <button class="btn" onclick="exportarMateriais()">Exportar Materiais</button>
                        <button class="btn" onclick="abrirModal('modal-importar-materiais')">Importar Materiais</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal para editar material -->
        <div id="modal-editar-material" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModal('modal-editar-material')">&times;</span>
                <h2>Editar Material</h2>
                <form id="form-editar-material">
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" id="edit-material-nome" required>
                    </div>
                    <div class="form-group">
                        <label>Pre√ßo:</label>
                        <input type="number" id="edit-material-preco" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Validade:</label>
                        <input type="date" id="edit-material-validade">
                    </div>
                    <div class="form-group">
                        <label>Quantidade:</label>
                        <input type="number" id="edit-material-quantidade" step="0.01" min="0">
                    </div>

                    <input list="lista-edit-material-unidade" id="edit-material-unidade" name="edit-material-unidade"
                        class="form-control  unid1" placeholder="Digite ou selecione">
                    <datalist id="lista-edit-material-unidade">
                        <!-- Massa -->
                        <option value="Quilograma (kg)">
                        <option value="Grama (g)">
                        <option value="Tonelada (t)">
                        <option value="Miligrama (mg)">

                            <!-- Volume -->
                        <option value="Litro (l)">
                        <option value="Mililitro (ml)">
                        <option value="Metro C√∫bico (m¬≥)">
                        <option value="Cent√≠metro C√∫bico (cm¬≥)">

                            <!-- Comprimento -->
                        <option value="Metro (m)">
                        <option value="Cent√≠metro (cm)">
                        <option value="Mil√≠metro (mm)">
                        <option value="Polegada (in)">
                        <option value="P√© (ft)">

                            <!-- √Årea -->
                        <option value="Metro Quadrado (m¬≤)">
                        <option value="Cent√≠metro Quadrado (cm¬≤)">

                            <!-- Tempo -->
                        <option value="Hora (h)">
                        <option value="Minuto (min)">
                        <option value="Segundo (s)">

                            <!-- Unidade -->
                        <option value="Unidade (un)">
                        <option value="Pacote (pc)">
                        <option value="Caixa (cx)">
                        <option value="D√∫zia (dz)">
                        <option value="Par (par)">
                    </datalist>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary"
                            onclick="fecharModal('modal-editar-material')">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal para editar or√ßamento -->
        <div id="modal-editar-orcamento" class="modal">
            <div class="modal-content modal-large">
                <span class="close" onclick="fecharModal('modal-editar-orcamento')">&times;</span>
                <h2>Editar Or√ßamento</h2>

                <!-- Informa√ß√µes b√°sicas -->
                <div class="form-section">
                    <h3>Informa√ß√µes B√°sicas</h3>
                    <form id="form-editar-orcamento">
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" id="edit-orcamento-nome" required>
                        </div>
                        <div class="form-group">
                            <label>Descri√ß√£o:</label>
                            <textarea id="edit-orcamento-descricao" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Margem de Lucro (%):</label>
                            <input type="number" id="edit-orcamento-margem" step="0.1" min="0">
                        </div>
                    </form>
                </div>

                <!-- Gerenciar itens -->
                <div class="form-section">
                    <h3>Gerenciar Itens</h3>

                    <!-- Adicionar novo item -->
                    <div class="add-item-section">
                        <h4>Adicionar Item</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nome:</label>
                                <div class="autocomplete-container" style="position: relative;">
                                    <div class="search-container">
                                        <input type="text" id="edit-item-nome" placeholder="Digite o nome do item"
                                            class="search-input" autocomplete="off"
                                            oninput="buscarAutocompleteEdicao()">
                                        <span class="clear-icon" onclick="limparCampoBusca(this)">√ó</span>
                                    </div>
                                    <div id="edit-dropdown-materiais" class="dropdown-suggestions"></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Pre√ßo:</label>
                                <input type="number" id="edit-item-preco" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Quantidade:</label>
                                <input type="number" id="edit-item-quantidade" step="0.01" min="0">
                            </div>
                            <input list="lista-edit-item-unidade" id="edit-item-unidade" name="edit-item-unidade"
                                class="form-control  unid1" placeholder="Digite ou selecione">
                            <datalist id="lista-edit-item-unidade">
                                <!-- Massa -->
                                <option value="Quilograma (kg)">
                                <option value="Grama (g)">
                                <option value="Tonelada (t)">
                                <option value="Miligrama (mg)">

                                    <!-- Volume -->
                                <option value="Litro (l)">
                                <option value="Mililitro (ml)">
                                <option value="Metro C√∫bico (m¬≥)">
                                <option value="Cent√≠metro C√∫bico (cm¬≥)">

                                    <!-- Comprimento -->
                                <option value="Metro (m)">
                                <option value="Cent√≠metro (cm)">
                                <option value="Mil√≠metro (mm)">
                                <option value="Polegada (in)">
                                <option value="P√© (ft)">

                                    <!-- √Årea -->
                                <option value="Metro Quadrado (m¬≤)">
                                <option value="Cent√≠metro Quadrado (cm¬≤)">

                                    <!-- Tempo -->
                                <option value="Hora (h)">
                                <option value="Minuto (min)">
                                <option value="Segundo (s)">

                                    <!-- Unidade -->
                                <option value="Unidade (un)">
                                <option value="Pacote (pc)">
                                <option value="Caixa (cx)">
                                <option value="D√∫zia (dz)">
                                <option value="Par (par)">
                            </datalist>

                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="button" class="btn btn-primary"
                                    onclick="adicionarItemEdicao()">Adicionar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de itens -->
                    <div class="items-list-section">
                        <h4>Itens do Or√ßamento</h4>
                        <div id="lista-itens-edicao"></div>
                    </div>

                    <!-- Totais -->
                    <div class="totais-edicao">
                        <div class="total-item">
                            <span>Subtotal:</span>
                            <span id="edit-subtotal">R$ 0,00</span>
                        </div>
                        <div class="total-item">
                            <span>Lucro:</span>
                            <span id="edit-lucro">R$ 0,00</span>
                        </div>
                        <div class="total-item total-final">
                            <span>TOTAL:</span>
                            <span id="edit-total">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="fecharModal('modal-editar-orcamento')">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoOrcamento()">Salvar
                        Altera√ß√µes</button>
                </div>
            </div>
        </div>

        <!-- Modal para ver detalhes do or√ßamento -->
        <div id="modal-detalhes-orcamento" class="modal">
            <div class="modal-content modal-large">
                <span class="close" onclick="fecharModal('modal-detalhes-orcamento')">&times;</span>
                <div id="conteudo-detalhes-orcamento"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="fecharModal('modal-detalhes-orcamento')">Fechar</button>
                    <button type="button" class="btn btn-primary"
                        onclick="compartilharOrcamento()">Compartilhar</button>
                    <button type="button" class="btn btn-success" onclick="imprimirOrcamento()">Imprimir</button>
                </div>
            </div>
        </div>
        <!-- Adicionar antes do fechamento do body -->
        <div id="modal-importar-orcamentos" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModal('modal-importar-orcamentos')">&times;</span>
                <h2>Importar Or√ßamentos</h2>
                <div class="import-section">
                    <label for="arquivo-orcamentos">Selecione o arquivo JSON:</label>
                    <input type="file" id="arquivo-orcamentos" accept=".json" onchange="lerArquivoOrcamentos(event)">
                </div>
                <div class="import-options">
                    <label>
                        <input type="checkbox" id="substituir-orcamentos" checked>
                        Substituir or√ßamentos existentes (se desmarcado, ir√° adicionar aos existentes)
                    </label>
                </div>
                <div class="modal-buttons">
                    <button class="btn" onclick="confirmarImportacaoOrcamentos()">Importar</button>
                    <button class="btn btn-secondary"
                        onclick="fecharModal('modal-importar-orcamentos')">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Adicionar antes do fechamento do body -->
        <div id="modal-importar-materiais" class="modal">
            <div class="modal-content">
                <span class="close" onclick="fecharModal('modal-importar-materiais')">&times;</span>
                <h2>Importar Materiais</h2>
                <div class="import-section">
                    <label for="arquivo-materiais">Selecione o arquivo JSON:</label>
                    <input type="file" id="arquivo-materiais" accept=".json" onchange="lerArquivoMateriais(event)">
                </div>
                <div class="import-options">
                    <label>
                        <input type="checkbox" id="substituir-materiais" checked>
                        Substituir materiais existentes (se desmarcado, ir√° adicionar aos existentes)
                    </label>
                </div>
                <div class="modal-buttons">
                    <button class="btn" onclick="confirmarImportacaoMateriais()">Importar</button>
                    <button class="btn btn-secondary"
                        onclick="fecharModal('modal-importar-materiais')">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notificacao" class="notificacao-oculta" onclick="fecharNotificacao()">
        <div class="notificacao-barra" onclick="event.stopPropagation()">
            <span id="notificacao-texto"></span>
        </div>
    </div>



    <script>
        // Vari√°veis globais
        let itensOrcamento = [];
        let materiais = [];
        let orcamentos = [];
        let orcamentosFiltrados = [];
        let materiaisFiltrados = [];
        // Vari√°vel para controlar o or√ßamento sendo editado
        let orcamentoEditando = null;
        let db;
        //variaveis para importar e exportar
        let dadosImportacaoOrcamentos = null;
        let dadosImportacaoMateriais = null;

        // Fun√ß√£o para normalizar texto (remover acentos e converter para min√∫sculas)
        function normalizarTexto(texto) {
            return texto.normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase();
        }

        // Inicializa√ß√£o do IndexedDB
        function initDB() {
            const request = indexedDB.open('OrcamentosDB', 1);

            request.onerror = function (event) {
                console.error('Erro ao abrir banco de dados');
            };

            request.onsuccess = function (event) {
                db = event.target.result;
                carregarDados();
            };

            request.onupgradeneeded = function (event) {
                db = event.target.result;

                // Criar tabela de or√ßamentos
                if (!db.objectStoreNames.contains('orcamentos')) {
                    const orcamentosStore = db.createObjectStore('orcamentos', { keyPath: 'id', autoIncrement: true });
                    orcamentosStore.createIndex('nome', 'nome', { unique: false });
                }

                // Criar tabela de materiais
                if (!db.objectStoreNames.contains('materiais')) {
                    const materiaisStore = db.createObjectStore('materiais', { keyPath: 'id', autoIncrement: true });
                    materiaisStore.createIndex('nome', 'nome', { unique: false });
                }
            };
        }

        // Carregar dados do IndexedDB
        function carregarDados() {
            carregarOrcamentos();
            carregarMateriais();
        }

        // Carregar or√ßamentos
        function carregarOrcamentos() {
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.getAll();

            request.onsuccess = function (event) {
                orcamentos = event.target.result;
                orcamentosFiltrados = [...orcamentos];
                renderizarOrcamentos();
            };
        }

        // Carregar materiais
        function carregarMateriais() {
            const transaction = db.transaction(['materiais'], 'readonly');
            const store = transaction.objectStore('materiais');
            const request = store.getAll();

            request.onsuccess = function (event) {
                materiais = event.target.result;
                materiaisFiltrados = [...materiais];
                renderizarMateriais();
                configurarAutocomplete(); // Configurar autocomplete ap√≥s carregar materiais
            };
        }

        // Controle de abas
        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');

            // Adicionar classe active ao bot√£o
            event.target.classList.add('active');
        }

        function adicionarItem() {
            const nome = document.getElementById('item-nome').value;
            const preco = parseFloat(document.getElementById('item-preco').value);
            const quantidade = parseFloat(document.getElementById('item-quantidade').value);
            const unidade = document.getElementById('item-unidade').value;

            if (!nome || !preco || !quantidade) {
                mostrarNotificacao('Por favor, preencha todos os campos');
                return;
            }

            // Procurar material j√° existente pelo nome (ou ajuste para outro crit√©rio se necess√°rio)
            const material = materiais.find(m => m.nome.toLowerCase() === nome.toLowerCase());

            const item = {
                id: Date.now(),
                nome: nome,
                preco: preco,
                quantidade: quantidade,
                unidade: unidade,
                total: preco * quantidade,
                materialId: material ? material.id : null,          // üëà necess√°rio
                quantidadeUsada: quantidade                         // üëà necess√°rio para subtrair do estoque
            };

            itensOrcamento.push(item);

            // Se o material ainda n√£o existe, adiciona automaticamente
            if (!material) {
                adicionarMaterialAutomatico(nome, preco, unidade);
            }

            // Limpar campos
            document.getElementById('item-nome').value = '';
            document.getElementById('item-preco').value = '';
            document.getElementById('item-quantidade').value = '';
            document.getElementById('dropdown-materiais').classList.remove('show');

            renderizarItens();
            calcularTotal();
        }


        // Adicionar material automaticamente
        function adicionarMaterialAutomatico(nome, preco, unidade) {
            // Verificar se j√° existe um material com o mesmo nome
            const materialExistente = materiais.find(m => m.nome.toLowerCase() === nome.toLowerCase());

            if (materialExistente) {
                // Se existe mas o pre√ßo √© diferente, atualizar o pre√ßo
                if (materialExistente.preco !== preco) {
                    const transaction = db.transaction(['materiais'], 'readwrite');
                    const store = transaction.objectStore('materiais');
                    materialExistente.preco = preco;
                    store.put(materialExistente);

                    // Atualizar array local
                    const index = materiais.findIndex(m => m.id === materialExistente.id);
                    materiais[index] = materialExistente;
                }
                return;
            }

            // Criar novo material
            const novoMaterial = {
                nome: nome,
                preco: preco,
                unidade: unidade
            };

            const transaction = db.transaction(['materiais'], 'readwrite');
            const store = transaction.objectStore('materiais');
            const request = store.add(novoMaterial);

            request.onsuccess = function (event) {
                novoMaterial.id = event.target.result;
                materiais.push(novoMaterial);
                materiaisFiltrados = [...materiais];
                renderizarMateriais();
            };
        }

        // Configurar autocomplete para materiais
        function configurarAutocomplete() {
            const inputNome = document.getElementById('item-nome');
            const dropdown = document.getElementById('dropdown-materiais');

            inputNome.addEventListener('input', function (e) {
                const valor = e.target.value.toLowerCase();

                if (valor.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }

                // Filtrar materiais que come√ßam com o texto digitado
                const materiaisFiltrados = materiais.filter(material =>
                    material.nome.toLowerCase().includes(valor)
                );

                if (materiaisFiltrados.length > 0) {
                    dropdown.innerHTML = materiaisFiltrados.map(material => `
                        <div class="dropdown-item" onclick="selecionarMaterial(${material.id})">
                            <div class="dropdown-item-name">${material.nome}</div>
                            <div class="dropdown-item-details">R$ ${material.preco.toFixed(2)} por ${material.unidade}</div>
                        </div>
                    `).join('');
                    dropdown.classList.add('show');
                } else {
                    dropdown.classList.remove('show');
                }
            });

            // Fechar dropdown quando clicar fora
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.autocomplete-container')) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Selecionar material do dropdown
        function selecionarMaterial(id) {
            const material = materiais.find(m => m.id === id);
            if (!material) return;

            document.getElementById('item-nome').value = material.nome;
            document.getElementById('item-preco').value = material.preco;
            document.getElementById('item-unidade').value = material.unidade;
            document.getElementById('dropdown-materiais').classList.remove('show');

            // Focar no campo de quantidade
            document.getElementById('item-quantidade').focus();
        }

        // Buscar or√ßamentos
        function buscarOrcamentos() {
            const termoBusca = document.getElementById('busca-orcamentos').value;

            if (termoBusca.trim() === '') {
                orcamentosFiltrados = [...orcamentos];
            } else {
                const termoNormalizado = normalizarTexto(termoBusca);
                orcamentosFiltrados = orcamentos.filter(orcamento => {
                    const nomeNormalizado = normalizarTexto(orcamento.nome);
                    const descricaoNormalizada = normalizarTexto(orcamento.descricao || '');

                    return nomeNormalizado.includes(termoNormalizado) ||
                        descricaoNormalizada.includes(termoNormalizado);
                });
            }

            renderizarOrcamentos();
        }

        // Buscar materiais
        function buscarMateriais() {
            const termoBusca = document.getElementById('busca-materiais').value;

            if (termoBusca.trim() === '') {
                materiaisFiltrados = [...materiais];
            } else {
                const termoNormalizado = normalizarTexto(termoBusca);
                materiaisFiltrados = materiais.filter(material => {
                    const nomeNormalizado = normalizarTexto(material.nome);

                    return nomeNormalizado.includes(termoNormalizado);
                });
            }

            renderizarMateriais();
        }

        // Renderizar itens do or√ßamento
        function renderizarItens() {
            const listaItens = document.getElementById('lista-itens');

            if (itensOrcamento.length === 0) {
                listaItens.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3em; margin-bottom: 20px;">üìã</div>
                        <p>Nenhum item adicionado ainda</p>
                    </div>
                `;
                return;
            }

            listaItens.innerHTML = itensOrcamento.map(item => `
                <div class="item">
                    <div class="item-info">
                        <div class="item-name">${item.nome}</div>
                        <div class="item-details">
                            ${item.quantidade} ${item.unidade} √ó R$ ${item.preco.toFixed(2)} = R$ ${item.total.toFixed(2)}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-danger" onclick="removerItem(${item.id})">Remover</button>
                    </div>
                </div>
            `).join('');
        }

        // Remover item
        function removerItem(id) {
            itensOrcamento = itensOrcamento.filter(item => item.id !== id);
            renderizarItens();
            calcularTotal();
        }

        // Calcular total
        function calcularTotal() {
            const subtotal = itensOrcamento.reduce((total, item) => total + item.total, 0);
            const margemLucro = parseFloat(document.getElementById('margem-lucro').value) || 0;
            const lucro = subtotal * (margemLucro / 100);
            const total = subtotal + lucro;

            document.getElementById('total-valor').textContent = total.toFixed(2).replace('.', ',');
        }

        // Salvar or√ßamento
        function salvarOrcamento() {
            const nome = document.getElementById('orcamento-nome').value;
            const descricao = document.getElementById('orcamento-descricao').value;
            const margemLucro = parseFloat(document.getElementById('margem-lucro').value) || 0;

            if (!nome || itensOrcamento.length === 0) {
                mostrarNotificacao('Por favor, preencha o nome e adicione pelo menos um item');
                return;
            }

            const subtotal = itensOrcamento.reduce((total, item) => total + item.total, 0);
            const lucro = subtotal * (margemLucro / 100);
            const total = subtotal + lucro;

            const orcamento = {
                nome: nome,
                descricao: descricao,
                itens: [...itensOrcamento],
                margemLucro: margemLucro,
                subtotal: subtotal,
                lucro: lucro,
                total: total,
                data: new Date().toLocaleDateString('pt-BR'),
                finalizado: false // üëà adicionado
            };

            // Salvar no IndexedDB
            const transaction = db.transaction(['orcamentos'], 'readwrite');
            const store = transaction.objectStore('orcamentos');
            const request = store.add(orcamento);

            request.onsuccess = function () {
                mostrarNotificacao('Or√ßamento salvo com sucesso!');
                limparOrcamento();
                carregarOrcamentos();
            };

            request.onerror = function () {
                mostrarNotificacao('Erro ao salvar or√ßamento');
            };
        }

        // Limpar or√ßamento
        function limparOrcamento() {
            document.getElementById('orcamento-nome').value = '';
            document.getElementById('orcamento-descricao').value = '';
            document.getElementById('margem-lucro').value = '';
            itensOrcamento = [];
            renderizarItens();
            calcularTotal();
        }

        function renderizarOrcamentos() {
            const listaOrcamentos = document.getElementById('lista-orcamentos');

            // Limite de or√ßamentos mostrados inicialmente
            const LIMITE_INICIAL = 3;

            if (orcamentosFiltrados.length === 0) {
                if (orcamentos.length === 0) {
                    listaOrcamentos.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3em; margin-bottom: 20px;">üìä</div>
                    <p>Nenhum or√ßamento salvo ainda</p>
                </div>
            `;
                } else {
                    listaOrcamentos.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3em; margin-bottom: 20px;">üîç</div>
                    <p>Nenhum or√ßamento encontrado com esse termo</p>
                </div>
            `;
                }
                return;
            }

            // Verifica se est√° fazendo busca ou n√£o
            const estaBuscando = document.getElementById('busca-orcamentos')?.value.trim().length > 0;

            const orcamentosOrdenados = (estaBuscando ? orcamentosFiltrados : orcamentosFiltrados.slice())
                .sort((a, b) => {
                    // 1. N√£o finalizados primeiro
                    if (a.finalizado !== b.finalizado) {
                        return a.finalizado ? 1 : -1;
                    }
                    // 2. Mais recentes primeiro
                    return b.id - a.id;
                });

            const orcamentosParaMostrar = orcamentosOrdenados.slice(0, LIMITE_INICIAL);


            // Renderiza os or√ßamentos na tela
            listaOrcamentos.innerHTML = orcamentosParaMostrar.map(orcamento => `
    <div class="item ${orcamento.finalizado ? 'finalizado' : ''}">
        <div class="item-info">
            <div class="item-name">
                ${orcamento.nome} ${orcamento.finalizado ? '‚úÖ' : ''}
            </div>
            <div class="item-details">
                ${orcamento.descricao || 'Sem descri√ß√£o'} | ${orcamento.itens.length} itens | R$ ${orcamento.total.toFixed(2)}
                <br>Criado em: ${orcamento.data}
            </div>
        </div>
        <div class="item-actions">
            <div class="juntos">
            <button class="btn" onclick="editarOrcamento(${orcamento.id})">Editar</button>
            <button class="btn btn-danger" onclick="excluirOrcamento(${orcamento.id})">Excluir</button>
            </div>
            <button class="btn" onclick="verOrcamento(${orcamento.id})">Ver Detalhes</button>
            
            ${!orcamento.finalizado
                    ? `<button class="btn btn-primary" onclick="finalizarOrcamento(${orcamento.id})">Finalizar</button>`
                    : ''}
        </div>
    </div>
`).join('');
        }


        // Ver detalhes do or√ßamento
        function verOrcamento(id) {
            const orcamento = orcamentos.find(o => o.id === id);
            if (!orcamento) return;

            const conteudo = document.getElementById('conteudo-detalhes-orcamento');
            conteudo.innerHTML = `
        <div class="orcamento-header">
            <h1 class="orcamento-title">${orcamento.nome}</h1>
            <p>${orcamento.descricao || 'Sem descri√ß√£o'}</p>
        </div>
        
        <div class="orcamento-info">
            <div class="info-item">
                <div class="info-label">Data de Cria√ß√£o</div>
                <div class="info-value">${orcamento.data}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Quantidade de Itens</div>
                <div class="info-value">${orcamento.itens.length} itens</div>
            </div>
            <div class="so-na-tela">
                <div class="info-item">
                    <div class="info-label">Margem de Lucro</div>
                    <div class="info-value">${orcamento.margemLucro}%</div>
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">Valor Total</div>
                <div class="info-value">R$ ${orcamento.total.toFixed(2).replace('.', ',')}</div>
            </div>
        </div>
        
        <h3>Itens do Or√ßamento</h3>
        <table class="itens-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Quantidade</th>
                    <th>Unidade</th>
                    <th>Pre√ßo Unit.</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                ${orcamento.itens.map(item => `
                    <tr>
                        <td>${item.nome}</td>
                        <td>${item.quantidade}</td>
                        <td>${item.unidade}</td>
                        <td>R$ ${item.preco.toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${item.total.toFixed(2).replace('.', ',')}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div class="totais-container">
            <div class="total-item">
                <span class="total-label">Subtotal:</span>
                <span class="total-value">R$ ${orcamento.subtotal.toFixed(2).replace('.', ',')}</span>
            </div>
            <div class="so-na-tela">
                <div class="total-item">
                    <span class="total-label">Lucro (${orcamento.margemLucro}%):</span>
                    <span class="total-value">R$ ${orcamento.lucro.toFixed(2).replace('.', ',')}</span>
                </div>
            </div>
            <div class="total-item">
                <span class="total-label">TOTAL FINAL:</span>
                <span class="total-value">R$ ${orcamento.total.toFixed(2).replace('.', ',')}</span>
            </div>
        </div>
    `;

            // Armazenar ID do or√ßamento atual para compartilhamento
            document.getElementById('modal-detalhes-orcamento').dataset.orcamentoId = id;
            abrirModal('modal-detalhes-orcamento');
        }

        // ADICIONAR estas novas fun√ß√µes:

        // Fun√ß√£o para abrir modal
        function abrirModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Fun√ß√£o para fechar modal
        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';

            // Limpar dados de edi√ß√£o quando fechar modal de or√ßamento
            if (modalId === 'modal-editar-orcamento') {
                orcamentoEditando = null;
                document.getElementById('edit-dropdown-materiais').classList.remove('show');
            }

            // ADICIONAR estas linhas para limpar dados de importa√ß√£o
            if (modalId === 'modal-importar-orcamentos') {
                dadosImportacaoOrcamentos = null;
                document.getElementById('arquivo-orcamentos').value = '';
            }

            if (modalId === 'modal-importar-materiais') {
                dadosImportacaoMateriais = null;
                document.getElementById('arquivo-materiais').value = '';
            }
        }

        // Fun√ß√£o para editar material
        function editarMaterial(id) {
            const material = materiais.find(m => m.id === id);
            if (!material) return;

            // Preencher formul√°rio
            document.getElementById('edit-material-nome').value = material.nome;
            document.getElementById('edit-material-preco').value = material.preco;
            document.getElementById('edit-material-unidade').value = material.unidade;
            // Adicionados: validade e quantidade
            document.getElementById('edit-material-validade').value = material.validade || '';
            document.getElementById('edit-material-quantidade').value = material.quantidade || 0;
            // Armazenar ID do material
            document.getElementById('form-editar-material').dataset.materialId = id;

            abrirModal('modal-editar-material');
        }

        // Fun√ß√£o para salvar altera√ß√µes do material
        function salvarEdicaoMaterial(event) {
            event.preventDefault();

            const form = event.target;
            const materialId = parseInt(form.dataset.materialId);
            const material = materiais.find(m => m.id === materialId);

            if (!material) return;

            material.nome = document.getElementById('edit-material-nome').value;
            material.preco = parseFloat(document.getElementById('edit-material-preco').value);
            material.unidade = document.getElementById('edit-material-unidade').value;
            material.validade = document.getElementById('edit-material-validade').value;
            material.quantidade = parseFloat(document.getElementById('edit-material-quantidade').value);

            const transaction = db.transaction(['materiais'], 'readwrite');
            const store = transaction.objectStore('materiais');
            const request = store.put(material);

            request.onsuccess = function () {
                mostrarNotificacao('Material atualizado com sucesso!');
                fecharModal('modal-editar-material');
                materiaisFiltrados = [...materiais];
                renderizarMateriais();
            };

            request.onerror = function () {
                mostrarNotificacao('Erro ao atualizar material');
            };
        }


        // Fun√ß√£o para editar or√ßamento
        // SUBSTITUIR a fun√ß√£o editarOrcamento por esta:
        function editarOrcamento(id) {
            const orcamento = orcamentos.find(o => o.id === id);
            if (!orcamento) return;

            // Criar c√≥pia do or√ßamento para edi√ß√£o
            orcamentoEditando = {
                ...orcamento,
                itens: [...orcamento.itens.map(item => ({ ...item }))]
            };

            // Preencher formul√°rio b√°sico
            document.getElementById('edit-orcamento-nome').value = orcamento.nome;
            document.getElementById('edit-orcamento-descricao').value = orcamento.descricao || '';
            document.getElementById('edit-orcamento-margem').value = orcamento.margemLucro;

            // Armazenar ID do or√ßamento
            document.getElementById('modal-editar-orcamento').dataset.orcamentoId = id;

            // Renderizar itens e configurar autocomplete
            renderizarItensEdicao();
            configurarAutocompleteEdicao();
            calcularTotaisEdicao();

            // Adicionar listener para mudan√ßa na margem
            document.getElementById('edit-orcamento-margem').addEventListener('input', calcularTotaisEdicao);

            abrirModal('modal-editar-orcamento');
        }

        // Fun√ß√£o para salvar altera√ß√µes do or√ßamento
        function salvarEdicaoOrcamento() {
            const modalElement = document.getElementById('modal-editar-orcamento');
            const orcamentoId = parseInt(modalElement.dataset.orcamentoId);
            const orcamento = orcamentos.find(o => o.id === orcamentoId);

            if (!orcamento) return;

            const nome = document.getElementById('edit-orcamento-nome').value;
            const descricao = document.getElementById('edit-orcamento-descricao').value;
            const margemLucro = parseFloat(document.getElementById('edit-orcamento-margem').value) || 0;

            if (!nome || orcamentoEditando.itens.length === 0) {
                mostrarNotificacao('Por favor, preencha o nome e adicione pelo menos um item');
                return;
            }

            // Atualizar dados do or√ßamento
            orcamento.nome = nome;
            orcamento.descricao = descricao;
            orcamento.margemLucro = margemLucro;
            orcamento.itens = [...orcamentoEditando.itens];

            // Recalcular totais
            orcamento.subtotal = orcamento.itens.reduce((total, item) => total + item.total, 0);
            orcamento.lucro = orcamento.subtotal * (margemLucro / 100);
            orcamento.total = orcamento.subtotal + orcamento.lucro;

            // Salvar no IndexedDB
            const transaction = db.transaction(['orcamentos'], 'readwrite');
            const store = transaction.objectStore('orcamentos');
            const request = store.put(orcamento);

            request.onsuccess = function () {
                mostrarNotificacao('Or√ßamento atualizado com sucesso!');
                fecharModal('modal-editar-orcamento');
                orcamentoEditando = null;
                orcamentosFiltrados = [...orcamentos];
                renderizarOrcamentos();
            };

            request.onerror = function () {
                mostrarNotificacao('Erro ao atualizar or√ßamento');
            };
        }

        // Fun√ß√£o para compartilhar or√ßamento
        function compartilharOrcamento() {
            const modalId = document.getElementById('modal-detalhes-orcamento').dataset.orcamentoId;
            const orcamento = orcamentos.find(o => o.id == modalId);

            if (!orcamento) return;

            const texto = `
OR√áAMENTO: ${orcamento.nome}

DESCRI√á√ÉO: ${orcamento.descricao || 'Sem descri√ß√£o'}

ITENS:
${orcamento.itens.map(item =>
                `‚Ä¢ ${item.nome}: ${item.quantidade} ${item.unidade} √ó R$ ${item.preco.toFixed(2)} = R$ ${item.total.toFixed(2)}`
            ).join('\n')}


TOTAL FINAL: R$ ${orcamento.total.toFixed(2)}

Data: ${orcamento.data}
    `.trim();

            if (navigator.share) {
                navigator.share({
                    title: `Or√ßamento: ${orcamento.nome}`,
                    text: texto
                });
            } else {
                // Fallback para copiar para clipboard
                navigator.clipboard.writeText(texto).then(() => {
                    mostrarNotificacao('Or√ßamento copiado para a √°rea de transfer√™ncia!');
                }).catch(() => {
                    // Fallback manual
                    const textarea = document.createElement('textarea');
                    textarea.value = texto;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    mostrarNotificacao('Or√ßamento copiado para a √°rea de transfer√™ncia!');
                });
            }
        }

        function imprimirOrcamento() {
            const conteudo = document.getElementById('conteudo-detalhes-orcamento').innerHTML;
            const janelaImpressao = window.open('', '_blank');

            janelaImpressao.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Or√ßamento</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .orcamento-header { text-align: center; margin-bottom: 30px; }
                .orcamento-title { font-size: 24px; margin-bottom: 10px; }
                .orcamento-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                .info-item { padding: 10px; border: 1px solid #ddd; }
                .info-label { font-weight: bold; color: #666; font-size: 12px; }
                .info-value { font-size: 14px; }
                .itens-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                .itens-table th, .itens-table td { padding: 8px; border: 1px solid #ddd; }
                .itens-table th { background-color: #f5f5f5; }
                .totais-container { border: 1px solid #ddd; padding: 15px; }
                .total-item { display: flex; justify-content: space-between; padding: 5px 0; }
                .total-item:last-child { font-weight: bold; font-size: 16px; }

                /* Oculta elementos s√≥ vis√≠veis na tela */
                @media print {
                    .so-na-tela {
                        display: none !important;
                    }
                }
            </style>
        </head>
        <body>
            ${conteudo}
        </body>
        </html>
    `);

            janelaImpressao.document.close();
            janelaImpressao.print();
        }


        // Fechar modal ao clicar fora
        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    fecharModal(modal.id);
                }
            });
        }

        // Excluir or√ßamento
        function excluirOrcamento(id) {
            if (!confirm('Tem certeza que deseja excluir este or√ßamento?')) return;

            const transaction = db.transaction(['orcamentos'], 'readwrite');
            const store = transaction.objectStore('orcamentos');
            const request = store.delete(id);

            request.onsuccess = function () {
                mostrarNotificacao('Or√ßamento exclu√≠do com sucesso!');
                carregarOrcamentos();
            };
        }

        // Salvar material
        function salvarMaterial() {
            const nome = document.getElementById('material-nome').value;
            const preco = parseFloat(document.getElementById('material-preco').value);
            const unidade = document.getElementById('material-unidade').value;
            const validade = document.getElementById('material-validade').value;
            const quantidade = parseFloat(document.getElementById('material-quantidade').value);

            if (!nome || isNaN(preco) || isNaN(quantidade)) {
                mostrarNotificacao('Por favor, preencha todos os campos obrigat√≥rios');
                return;
            }

            const material = {
                nome,
                preco,
                unidade,
                validade,
                quantidade
            };

            const transaction = db.transaction(['materiais'], 'readwrite');
            const store = transaction.objectStore('materiais');
            const request = store.add(material);

            request.onsuccess = function () {
                mostrarNotificacao('Material salvo com sucesso!');
                document.getElementById('material-nome').value = '';
                document.getElementById('material-preco').value = '';
                document.getElementById('material-validade').value = '';
                document.getElementById('material-quantidade').value = '';
                carregarMateriais();
            };
        }


        // Renderizar materiais
        function renderizarMateriais() {
            const listaMateriais = document.getElementById('lista-materiais');

            // Limite de materiais exibidos quando n√£o h√° filtro
            const LIMITE_INICIAL = 3;

            if (materiaisFiltrados.length === 0) {
                if (materiais.length === 0) {
                    listaMateriais.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3em; margin-bottom: 20px;">üì¶</div>
                    <p>Nenhum material cadastrado ainda</p>
                </div>
            `;
                } else {
                    listaMateriais.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3em; margin-bottom: 20px;">üîç</div>
                    <p>Nenhum material encontrado com esse termo</p>
                </div>
            `;
                }
                return;
            }

            // Se n√£o h√° busca (campo vazio), renderiza s√≥ os primeiros N
            const estaBuscando = document.getElementById('busca-materiais')?.value.trim().length > 0;
            const materiaisParaMostrar = (estaBuscando
                ? materiaisFiltrados
                : materiaisFiltrados.slice(0, LIMITE_INICIAL)).sort((a, b) => b.id - a.id);


            listaMateriais.innerHTML = materiaisParaMostrar.map(material => {
                const qtdStatus = getClasseQuantidade(material.quantidade);
                const valStatus = getClasseValidade(material.validade);

                return `
        <div class="item">
            <div class="item-info">
                <div class="item-name">${material.nome}</div>
                <div class="item-details">R$ ${material.preco.toFixed(2)} por ${material.unidade}</div>
                <div class="item-estoque ${qtdStatus.classe}">
                    ${qtdStatus.icone} Qtd: ${material.quantidade}
                </div>
                <div class="item-validade ${valStatus.classe}">
                    ${valStatus.icone} Val: ${material.validade || '---'}
                </div>
            </div>
            <div class="item-actions">
                <button class="btn" onclick="usarMaterial(${material.id})">Usar no Or√ßamento</button>
                <div class="juntos">
                <button class="btn" onclick="editarMaterial(${material.id})">Editar</button>
                <button class="btn btn-danger" onclick="excluirMaterial(${material.id})">Excluir</button>
                </div>
            </div>
        </div>
    `;
            }).join('');

        }


        // Usar material no or√ßamento
        function usarMaterial(id) {
            const material = materiais.find(m => m.id === id);
            if (!material) return;

            document.getElementById('item-nome').value = material.nome;
            document.getElementById('item-preco').value = material.preco;
            document.getElementById('item-unidade').value = material.unidade;

            // Mudar para a aba de novo or√ßamento
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('novo-orcamento').classList.add('active');
            document.querySelector('.tab').classList.add('active');

            // Focar no campo de quantidade
            document.getElementById('item-quantidade').focus();
        }

        // Excluir material
        function excluirMaterial(id) {
            if (!confirm('Tem certeza que deseja excluir este material?')) return;

            const transaction = db.transaction(['materiais'], 'readwrite');
            const store = transaction.objectStore('materiais');
            const request = store.delete(id);

            request.onsuccess = function () {
                mostrarNotificacao('Material exclu√≠do com sucesso!');
                carregarMateriais();
            };
        }
        // NOVA fun√ß√£o para renderizar itens na edi√ß√£o
        function renderizarItensEdicao() {
            const listaItens = document.getElementById('lista-itens-edicao');

            if (!orcamentoEditando.itens || orcamentoEditando.itens.length === 0) {
                listaItens.innerHTML = `
            <div class="empty-items">
                <div class="empty-items-icon">üìã</div>
                <p>Nenhum item no or√ßamento</p>
            </div>
        `;
                return;
            }

            listaItens.innerHTML = orcamentoEditando.itens.map(item => `
        <div class="item-edicao">
            <div class="item-edicao-info">
                <div class="item-edicao-nome">${item.nome}</div>
                <div class="item-edicao-detalhes">
                    ${item.quantidade} ${item.unidade} √ó R$ ${item.preco.toFixed(2)} = R$ ${item.total.toFixed(2)}
                </div>
            </div>
            <div class="item-edicao-actions">
                <button class="btn btn-small" onclick="editarItemEdicao(${item.id})">Editar</button>
                <button class="btn btn-danger btn-small" onclick="removerItemEdicao(${item.id})">Remover</button>
            </div>
        </div>
    `).join('');
        }

        // NOVA fun√ß√£o para configurar autocomplete na edi√ß√£o
        function configurarAutocompleteEdicao() {
            const inputNome = document.getElementById('edit-item-nome');
            const dropdown = document.getElementById('edit-dropdown-materiais');

            inputNome.addEventListener('input', function (e) {
                const valor = e.target.value.toLowerCase();

                if (valor.length === 0) {
                    dropdown.innerHTML = '';
                    dropdown.classList.remove('show');
                    return;
                }

                const materiaisFiltrados = materiais.filter(material =>
                    material.nome.toLowerCase().includes(valor)
                );

                if (materiaisFiltrados.length > 0) {
                    dropdown.innerHTML = materiaisFiltrados.map(material => `
                <div class="dropdown-item" onclick="selecionarMaterialEdicao(${material.id})">
                    <div class="dropdown-item-name">${material.nome}</div>
                    <div class="dropdown-item-details">R$ ${material.preco.toFixed(2)} por ${material.unidade}</div>
                </div>
            `).join('');
                    dropdown.classList.add('show');
                } else {
                    dropdown.innerHTML = '';
                    dropdown.classList.remove('show');
                }
            });

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.autocomplete-container')) {
                    dropdown.classList.remove('show');
                }
            });
        }


        // NOVA fun√ß√£o para selecionar material na edi√ß√£o
        function selecionarMaterialEdicao(id) {
            const material = materiais.find(m => m.id === id);
            if (!material) return;

            document.getElementById('edit-item-nome').value = material.nome;
            document.getElementById('edit-item-preco').value = material.preco;
            document.getElementById('edit-item-unidade').value = material.unidade;
            document.getElementById('edit-dropdown-materiais').classList.remove('show');

            // Focar no campo de quantidade, se quiser
            document.getElementById('edit-item-quantidade').focus();
        }


        // NOVA fun√ß√£o para adicionar item na edi√ß√£o
        function adicionarItemEdicao() {
            const nome = document.getElementById('edit-item-nome').value;
            const preco = parseFloat(document.getElementById('edit-item-preco').value);
            const quantidade = parseFloat(document.getElementById('edit-item-quantidade').value);
            const unidade = document.getElementById('edit-item-unidade').value;

            if (!nome || !preco || !quantidade) {
                mostrarNotificacao('Por favor, preencha todos os campos');
                return;
            }

            const novoItem = {
                id: Date.now(),
                nome: nome,
                preco: preco,
                quantidade: quantidade,
                unidade: unidade,
                total: preco * quantidade
            };

            orcamentoEditando.itens.push(novoItem);

            // Adicionar automaticamente como material se n√£o existir
            adicionarMaterialAutomatico(nome, preco, unidade);

            // Limpar campos
            document.getElementById('edit-item-nome').value = '';
            document.getElementById('edit-item-preco').value = '';
            document.getElementById('edit-item-quantidade').value = '';
            document.getElementById('edit-dropdown-materiais').classList.remove('show');

            renderizarItensEdicao();
            calcularTotaisEdicao();
        }

        // NOVA fun√ß√£o para remover item na edi√ß√£o
        function removerItemEdicao(id) {
            if (!confirm('Tem certeza que deseja remover este item?')) return;

            orcamentoEditando.itens = orcamentoEditando.itens.filter(item => item.id !== id);
            renderizarItensEdicao();
            calcularTotaisEdicao();
        }

        // NOVA fun√ß√£o para editar item na edi√ß√£o
        function editarItemEdicao(id) {
            const item = orcamentoEditando.itens.find(i => i.id === id);
            if (!item) return;

            // Preencher campos com dados do item
            document.getElementById('edit-item-nome').value = item.nome;
            document.getElementById('edit-item-preco').value = item.preco;
            document.getElementById('edit-item-quantidade').value = item.quantidade;
            document.getElementById('edit-item-unidade').value = item.unidade;

            // Remover item temporariamente
            orcamentoEditando.itens = orcamentoEditando.itens.filter(i => i.id !== id);
            renderizarItensEdicao();
            calcularTotaisEdicao();

            // Focar no campo de nome
            document.getElementById('edit-item-nome').focus();
        }

        // NOVA fun√ß√£o para calcular totais na edi√ß√£o
        function calcularTotaisEdicao() {
            const subtotal = orcamentoEditando.itens.reduce((total, item) => total + item.total, 0);
            const margemLucro = parseFloat(document.getElementById('edit-orcamento-margem').value) || 0;
            const lucro = subtotal * (margemLucro / 100);
            const total = subtotal + lucro;

            document.getElementById('edit-subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('edit-lucro').textContent = `R$ ${lucro.toFixed(2).replace('.', ',')}`;
            document.getElementById('edit-total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        //fun√ß√£o limpar a busca ao pressionar o bot√£o x
        function limparCampoBusca(elementoX) {
            const input = elementoX.previousElementSibling;
            input.value = '';
            input.dispatchEvent(new Event('input')); // reexecuta a busca
        }

        //fun√ßao gen√©rica ocultar uma div
        // function toggleVisibilidade(idElemento) {
        //     const elemento = document.getElementById(idElemento);
        //     elemento.classList.toggle('oculto');
        //     elemento.classList.toggle('visivel');
        // }

        // Fun√ß√£o para exportar or√ßamentos
        function exportarOrcamentos() {
            if (orcamentos.length === 0) {
                mostrarNotificacao('N√£o h√° or√ßamentos para exportar');
                return;
            }

            const dadosExportacao = {
                tipo: 'orcamentos',
                versao: '1.0',
                dataExportacao: new Date().toISOString(),
                quantidade: orcamentos.length,
                dados: orcamentos
            };

            const arquivo = new Blob([JSON.stringify(dadosExportacao, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(arquivo);
            const link = document.createElement('a');
            link.href = url;
            link.download = `orcamentos_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarNotificacao(`${orcamentos.length} or√ßamentos ser√£o exportados!`);
        }

        // Fun√ß√£o para exportar materiais
        function exportarMateriais() {
            if (materiais.length === 0) {
                mostrarNotificacao('N√£o h√° materiais para exportar');
                return;
            }

            const dadosExportacao = {
                tipo: 'materiais',
                versao: '1.0',
                dataExportacao: new Date().toISOString(),
                quantidade: materiais.length,
                dados: materiais
            };

            const arquivo = new Blob([JSON.stringify(dadosExportacao, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(arquivo);
            const link = document.createElement('a');
            link.href = url;
            link.download = `materiais_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarNotificacao(`${materiais.length} materiais ser√£o exportados!`);
        }

        // Fun√ß√£o para ler arquivo de or√ßamentos
        function lerArquivoOrcamentos(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const dados = JSON.parse(e.target.result);

                    // Validar estrutura do arquivo
                    if (!dados.tipo || dados.tipo !== 'orcamentos') {
                        throw new Error('Arquivo n√£o √© um backup de or√ßamentos v√°lido');
                    }

                    if (!dados.dados || !Array.isArray(dados.dados)) {
                        throw new Error('Formato de arquivo inv√°lido');
                    }

                    dadosImportacaoOrcamentos = dados.dados;
                    mostrarNotificacao(`Arquivos encontrados com sucesso! Encontrados ${dados.dados.length} or√ßamentos.`);

                } catch (error) {
                    mostrarNotificacao('Erro ao ler arquivo: ' + error.message);
                    dadosImportacaoOrcamentos = null;
                }
            };

            reader.readAsText(arquivo);
        }

        // Fun√ß√£o para ler arquivo de materiais
        function lerArquivoMateriais(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const dados = JSON.parse(e.target.result);

                    // Validar estrutura do arquivo
                    if (!dados.tipo || dados.tipo !== 'materiais') {
                        throw new Error('Arquivo n√£o √© um backup de materiais v√°lido');
                    }

                    if (!dados.dados || !Array.isArray(dados.dados)) {
                        throw new Error('Formato de arquivo inv√°lido');
                    }

                    dadosImportacaoMateriais = dados.dados;
                    mostrarNotificacao(`Arquivo encontrados com sucesso! Encontrados ${dados.dados.length} materiais.`);

                } catch (error) {
                    mostrarNotificacao('Erro ao ler arquivo: ' + error.message);
                    dadosImportacaoMateriais = null;
                }
            };

            reader.readAsText(arquivo);
        }

        // Fun√ß√£o para confirmar importa√ß√£o de or√ßamentos
        function confirmarImportacaoOrcamentos() {
            if (!dadosImportacaoOrcamentos) {
                mostrarNotificacao('Por favor, selecione um arquivo primeiro');
                return;
            }

            const substituir = document.getElementById('substituir-orcamentos').checked;

            if (substituir && orcamentos.length > 0) {
                if (!confirm('Isto ir√° substituir todos os or√ßamentos existentes. Continuar?')) {
                    return;
                }
            }

            const transaction = db.transaction(['orcamentos'], 'readwrite');
            const store = transaction.objectStore('orcamentos');

            // Se escolheu substituir, limpar dados existentes
            if (substituir) {
                store.clear();
            }

            let importadosComSucesso = 0;
            let totalParaImportar = dadosImportacaoOrcamentos.length;

            dadosImportacaoOrcamentos.forEach(orcamento => {
                // Remover ID para evitar conflitos
                const { id, ...orcamentoSemId } = orcamento;

                const request = store.add(orcamentoSemId);

                request.onsuccess = function () {
                    importadosComSucesso++;

                    if (importadosComSucesso === totalParaImportar) {
                        mostrarNotificacao(`Importa√ß√£o conclu√≠da! ${importadosComSucesso} or√ßamentos importados.`);
                        fecharModal('modal-importar-orcamentos');
                        carregarOrcamentos();

                        // Limpar dados tempor√°rios
                        dadosImportacaoOrcamentos = null;
                        document.getElementById('arquivo-orcamentos').value = '';
                    }
                };

                request.onerror = function () {
                    console.error('Erro ao importar or√ßamento:', orcamento.nome);
                };
            });
        }

        // Fun√ß√£o para confirmar importa√ß√£o de materiais
        function confirmarImportacaoMateriais() {
            if (!dadosImportacaoMateriais) {
                mostrarNotificacao('Por favor, selecione um arquivo primeiro');
                return;
            }

            const substituir = document.getElementById('substituir-materiais').checked;

            if (substituir && materiais.length > 0) {
                if (!confirm('Isto ir√° substituir todos os materiais existentes. Continuar?')) {
                    return;
                }
            }

            const transaction = db.transaction(['materiais'], 'readwrite');
            const store = transaction.objectStore('materiais');

            // Se escolheu substituir, limpar dados existentes
            if (substituir) {
                store.clear();
            }

            let importadosComSucesso = 0;
            let totalParaImportar = dadosImportacaoMateriais.length;

            dadosImportacaoMateriais.forEach(material => {
                // Remover ID para evitar conflitos
                const { id, ...materialSemId } = material;

                const request = store.add(materialSemId);

                request.onsuccess = function () {
                    importadosComSucesso++;

                    if (importadosComSucesso === totalParaImportar) {
                        mostrarNotificacao(`Importa√ß√£o conclu√≠da! ${importadosComSucesso} materiais importados.`);
                        fecharModal('modal-importar-materiais');
                        carregarMateriais();

                        // Limpar dados tempor√°rios
                        dadosImportacaoMateriais = null;
                        document.getElementById('arquivo-materiais').value = '';
                    }
                };

                request.onerror = function () {
                    console.error('Erro ao importar material:', material.nome);
                };
            });
        }
        //fun√ß√µes para cores de quantidade e validade
        function getClasseQuantidade(quantidade) {
            if (quantidade <= 0) return { classe: 'qtd-vermelho', icone: '‚ùó' };
            if (quantidade <= 5) return { classe: 'qtd-laranja', icone: '‚ö†Ô∏è' };
            if (quantidade <= 20) return { classe: 'qtd-verde', icone: '‚úÖ' };
            if (quantidade <= 100) return { classe: 'qtd-azul', icone: 'üì¶' };
            return { classe: 'qtd-roxo', icone: 'üü£' };
        }

        function getClasseValidade(dataValidade) {
            if (!dataValidade) return { classe: 'val-sem-info', icone: '‚ùì' };

            const hoje = new Date();
            const validade = new Date(dataValidade);
            const diffDias = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));

            if (diffDias < 0) return { classe: 'val-vermelho', icone: '‚ùå' };
            if (diffDias <= 5) return { classe: 'val-laranja', icone: '‚è∞' };
            if (diffDias <= 30) return { classe: 'val-verde', icone: '‚è≥' };
            if (diffDias <= 90) return { classe: 'val-azul', icone: 'üóìÔ∏è' };
            return { classe: 'val-roxo', icone: 'üìÖ' };
        }

        function finalizarOrcamento(id) {
            const orcamento = orcamentos.find(o => o.id === id);
            if (!orcamento || orcamento.finalizado) return;

            if (!confirm("Deseja realmente finalizar este or√ßamento? Isso ir√° subtrair os materiais do estoque.")) {
                return;
            }

            // Marca como finalizado
            orcamento.finalizado = true;

            const transaction = db.transaction(['orcamentos', 'materiais'], 'readwrite');
            const storeOrc = transaction.objectStore('orcamentos');
            const storeMat = transaction.objectStore('materiais');

            // Atualiza o or√ßamento no DB
            storeOrc.put(orcamento);

            // Atualiza materiais
            orcamento.itens.forEach(item => {
                const material = materiais.find(m => m.id === item.materialId);
                if (material) {
                    material.quantidade = Math.max(0, material.quantidade - item.quantidadeUsada); // Evita negativo
                    storeMat.put(material);
                }
            });

            transaction.oncomplete = () => {
                mostrarNotificacao('Or√ßamento finalizado e estoque atualizado!');
                carregarOrcamentos();
                carregarMateriais(); // Atualiza lista de materiais com as novas quantidades
            };

            transaction.onerror = () => {
                mostrarNotificacao('Erro ao finalizar or√ßamento.');
            };
        }

        let notificacaoTimeout = null;

        function mostrarNotificacao(mensagem, duracao = 3000) {
            const container = document.getElementById('notificacao');
            const texto = document.getElementById('notificacao-texto');

            texto.textContent = mensagem;
            container.style.display = 'flex';

            // Limpa qualquer timeout anterior
            if (notificacaoTimeout) {
                clearTimeout(notificacaoTimeout);
            }

            // Fecha automaticamente ap√≥s o tempo definido
            notificacaoTimeout = setTimeout(() => {
                fecharNotificacao();
            }, duracao);
        }

        function fecharNotificacao() {
            const container = document.getElementById('notificacao');
            container.style.display = 'none';
            notificacaoTimeout = null;
        }




        // Eventos
        document.getElementById('margem-lucro').addEventListener('input', calcularTotal);
        // Event listeners para os formul√°rios dos modais
        document.getElementById('form-editar-material').addEventListener('submit', salvarEdicaoMaterial);
        document.getElementById('form-editar-orcamento').addEventListener('submit', salvarEdicaoOrcamento);
        // Adicionar junto com os outros event listeners:
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.autocomplete-container')) {
                const dropdown = document.getElementById('edit-dropdown-materiais');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        });

        // Inicializar aplica√ß√£o
        initDB();
    </script>
</body>

</html>